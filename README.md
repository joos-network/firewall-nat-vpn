# firewall-nat-vpn
Firewall, NAT, VPN

**Firewall** - дополнительный слой защиты между вами и проблемами

**Задача Firewall** - фильтрация проходящего через него трафика на основе определенных ранее правил. Это Защита сетей или отдельных хостов от атак, направленных извне внутрь защищаемой сети

**Netfilter** - межсетевой экран, встроенный в ядро Linux, начиная с версии 2.4

**iptables** - утилита Netfilter - Можно создавать и изменять правила, которые фильтруют трафик - является полноценным инструментом позволяющим настроить фаерволл

**firewalld** - Аналог iptables - В операционных системах CentOS, Fedora, OpenSUSE, Red Hat Enterprise Linux, SUSE Linux Enterprise

Архитектура Netfilter
- Подразумевает прохождение пакетов через цепочки правил
- Каждое правило содержит различные критерии и действие или переход, выполняющиеся в случае полного соответствия пакета критериям 
- Отсутствие критериев применяет правило ко всем проходящим через него пакетам

Cостав правила iptables
- Условие - Логическое выражение на основании которого происходит анализ свойств пакета / соединения и которое определяет попадание пакета / соединения под текущее правило
- Действие - Выполняется в случае соответствия пакета / соединения текущему правилу
- Счетчик - Учитывает количество пакетов попавших под условие текущего правила

**Цепочки iptables** - упорядоченная последовательность правил
- Пользовательская цепочка - Создаётся пользователем и используется только в пределах своей таблицы
- Базовая цепочка - Создаётся по умолчанию при создании таблицы и в отличии от пользовательской обладает действием по умолчанию

**Базовые цепочки iptables** - PREROUTING, INPUT, FORWARD, OUTPUT, POSTROUTING

**Таблица iptables** - совокупность базовых и пользовательских цепочек, имеющих общее назначение

**Conntrack (англ. отслеживание соединения)** - специальная подсистема, отслеживающая состояния соединений и позволяющая использовать эту информацию при принятии решений о судьбе отдельных пакетов

Состояния соединений
- NEW - пакет является первым в соединении
- ESTABLISHED - пакет относится к уже установленному соединению
- RELATED - пакет открывает новое соединение, логически связанное с уже установленными
- INVALID - установить принадлежность пакета не удалось
- UNTRACKED - отслеживание состояния соединения для данного пакета было отключено

**Host** - любое устройство подключенное к сети TCP/IP, принимающее или создающее подключения

**Localhost** - с помощью специального сетевого интерфейса «внутренней петли» (loopback) позволяет создавать сети, состоящие из одного компьютера

Цепочки iptables:
- Цепочка PREROUTING - Предмаршрутная обработка - Обрабатываются все входящие пакеты - Содержатся правила, обработка которых идет до решения о дальнейшей маршрутизации пакета (локальному процессу или другой машине в сети)
- - Для управления отслеживанием (таблица raw): отменить, настроить, ограничить отслеживание и т.д
- - Если необходимо модифицировать пакет до маршрутизации (mangle), например изменить поле TOS (IPv4), DSCP, TTL. Также можно сделать маркировку пакета или соединения
- - Для изменения адреса получателя в таблице nat: как IP-адреса через (Destination Network Address Translation) так и порта (с помощью действия REDIRECT) (Скрытие порта приложения с помощью таблицы nat (REDIRECT с внешнего порта 12345 на 22 в локальной сети))
- Цепочка INPUT - Входящие пакеты - Обрабатываются входящие пакеты, адресованные локальному процессу
- - Изменение заголовка пакета, прежде чем он попадет к локальному процессу (таблица mangle)
- - Фильтрация входящего трафика (таблица filter)
- - Передача специфичным системам принудительного контроля доступа (security) Данная таблица появляется только с использованием возможностей SELinux
- - Иногда необходимо обработать два идентичных потока из разных зон, когда получателем выступает машина с фаерволом. В таких случаях в цепочке INPUT используется таблица nat
- Цепочка FORWARD - Пересылка пакетов - Обрабатываются входящие пакеты, которые пересылаются дальше
- - В исключительных случаях вносить изменение в заголовок транзитного пакета
- - Фильтрация трафика, идущего в обоих направлениях (в локальную и внешнюю сеть)
- Цепочка OUTPUT - Исходящие пакеты - Предназначена для пакетов, исходящих от внутренних процессов
- - Управления отслеживанием (таблица raw), как то: задать зону conntrack для пакета, отменить, настроить, ограничить отслеживание и т.д.
- - Внесение изменений в заголовок исходящего пакета (таблица mangle)
- - Повторения в случае необходимости подмены адресов (IP, порт TCP) для локально созданных пакетов (таблица nat)
- - Обычной (таблица filter) и усиленной (таблица security) фильтрации исходящих пакетов
- Цепочка POSTROUTING - Постмаршрутизация - Происходит окончательная обработка исходящих пакетов
- - Внесения изменения в заголовок исходящего или транзитного пакета/сегмента уже после того, как принято последнее решение о маршрутизации (таблица mangle)
- - Замены адреса отправителя (Source Network Address Translation), проводить операции маскарадинга (таблица nat)

**Утилита netstat** - позволяет смотреть состояния соединений, таблиц маршрутизации, чисто сетевых интерфейсов и статистику по протоколам

- **netstat -l** - Посмотреть все сокеты с состоянием LISTEN
- **netstat -s** - Узнать статистику для каждого протокола

Шаблон работы с iptables
iptables [-t table] command [match] [target/jump]
- -t – указывает на таблицу (raw, mangle, nat, security), по умолчанию без указания параметра выбирается таблица filter
- [match] – задает критерии проверки, по которым определяется подпадает ли пакет под действие этого правила или нет
- [target] – указывает, какое действие должно быть выполнено при условии выполнения критериев в правиле

При начальной настройке всегда нужно задавать политику обработки пакетов по умолчанию для каждой цепочки
- sudo iptables -P INPUT DROP
- sudo iptables -P FORWARD DROP

Команда для просмотра таблиц iptables
- sudo iptables -nvL -t raw
- sudo iptables -nvL -t mangle
- sudo iptables -nvL -t nat
- sudo iptables -nvL -t filter

Пример добавления правила iptables
- Используем команду:
- sudo iptables -A INPUT -p tcp --dport 22 -m state --state NEW,ESTABLISHED -s 192.168.0.0/24 -j ACCEPT
- -A INPUT – (append, добавить) указывает цепочку (например, INPUT ) для добавления правила
- -p tcp – указываем сетевой протокол (например, tcp или udp )
- --dport 22 – порт назначения пакетов
- -m state – критерий, свойство пакета, которое мы хотим сопоставить (например, state )
- --state NEW, ESTABLISHED – состояние(я) пакета для соответствия
- -s 192.168.0.0/24 – (source, источник) IP-адрес и маска источника, из которого исходят пакеты
- -j ACCEPT – цель или что делать с пакетами (например, ACCEPT, DROP, REJECT и т. д.)

**Ebtables** - средство для фильтрации пакетов для программных мостов Linux, работает преимущественно на втором (канальном) уровне модели OSI. Ebtables предназначена для фильтрации трафика в bridge

Чтобы отбросить трафик от конкретного MAC адреса в ebtables необходима следующая команда:
- ebtables -A INPUT -s 08:00:27:47:88:CE -j DROP
Вариант, который мы использовали в iptables:
- sudo iptables -A INPUT -m mac --mac-source 08:00:27:47:88:CE -j DROP


